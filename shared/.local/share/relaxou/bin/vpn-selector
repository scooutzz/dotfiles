#!/usr/bin/env bash

# VPN Selector para Hyprland + wofi
# Adaptado do script original
# Autor: scooutzz

# FunÃ§Ã£o para verificar se NetworkManager estÃ¡ rodando
check_nm() {
    if ! systemctl is-active --quiet NetworkManager; then
        notify-send "VPN Selector" "NetworkManager not working!" \
            --icon=dialog-error \
            --urgency=critical \
            --expire-time=2000
        exit 1
    fi
}

# FunÃ§Ã£o para obter status da VPN
get_vpn_status() {
    local active_vpn=$(nmcli -t -f NAME,TYPE connection show --active | grep ":vpn" | cut -d: -f1)
    echo "$active_vpn"
}

# FunÃ§Ã£o para obter lista de VPNs
get_vpn_list() {
    nmcli -t -f NAME,TYPE connection show | grep ":vpn" | cut -d: -f1
}

# FunÃ§Ã£o para conectar VPN
connect_vpn() {
    local vpn_name="$1"
    
    notify-send "VPN Selector" "Connectin to $vpn_name..." \
        --icon=network-vpn \
        --urgency=normal \
        --expire-time=2000
    
    if nmcli connection up "$vpn_name" &>/dev/null; then
        notify-send "VPN Selector" "âœ… Connected to $vpn_name" \
            --icon=network-vpn \
            --urgency=normal \
            --expire-time=2000
    else
        notify-send "VPN Selector" "âŒ Error connecting to $vpn_name" \
            --icon=dialog-error \
            --urgency=critical \
            --expire-time=2000
    fi
}

# FunÃ§Ã£o para desconectar VPN
disconnect_vpn() {
    local vpn_name="$1"
    
    notify-send "VPN Selector" "Disconnecting from $vpn_name..." \
        --icon=network-vpn \
        --urgency=normal \
        --expire-time=2000
    
    if nmcli connection down "$vpn_name" &>/dev/null; then
        notify-send "VPN Selector" "ğŸ”“ Disconnected from $vpn_name" \
            --icon=network-offline \
            --urgency=normal \
            --expire-time=2000
    else
        notify-send "VPN Selector" "âŒ Failed disconnecting from $vpn_name" \
            --icon=dialog-error \
            --urgency=critical \
            --expire-time=2000
    fi
}

# Verifica se NetworkManager estÃ¡ rodando
check_nm

# Busca VPN ativa
ACTIVE_VPN=$(get_vpn_status)

# Busca todas VPNs cadastradas
VPN_LIST=$(get_vpn_list)

# Verifica se hÃ¡ VPNs configuradas
if [[ -z "$VPN_LIST" ]]; then
    notify-send "VPN Selector" "No VPN configured in NetworkManager!" \
        --icon=dialog-information \
        --urgency=normal \
        --expire-time=2000
    exit 1
fi

# Monta o menu
MENU_ITEMS=()

# Se hÃ¡ VPN ativa, mostra status e opÃ§Ã£o de desconectar
if [[ -n "$ACTIVE_VPN" ]]; then
    MENU_ITEMS+=("ğŸŸ¢ Ativa: $ACTIVE_VPN")
    MENU_ITEMS+=("ğŸ”“ Desconectar VPN")
    MENU_ITEMS+=("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
fi

# Adiciona as VPNs disponÃ­veis
while IFS= read -r vpn; do
    if [[ "$vpn" != "$ACTIVE_VPN" ]]; then
        MENU_ITEMS+=("ğŸ”’ $vpn")
    fi
done <<< "$VPN_LIST"

# Se nÃ£o hÃ¡ VPN ativa, adiciona todas
if [[ -z "$ACTIVE_VPN" ]]; then
    MENU_ITEMS=()
    while IFS= read -r vpn; do
        MENU_ITEMS+=("ğŸ”’ $vpn")
    done <<< "$VPN_LIST"
fi

# Converte array em string separada por nova linha
MENU=$(printf "%s\n" "${MENU_ITEMS[@]}")

# Configura wofi com tema customizado
WOFI_OPTS=(
    --dmenu
    --prompt "ğŸ›¡ï¸ VPN Selector"
    --lines 8
    --width 400
    --height 300
    --insensitive
    --allow-markup
    --no-actions
)

# Exibe o menu via wofi
SELECTED=$(echo -e "$MENU" | wofi "${WOFI_OPTS[@]}")

# Processa a seleÃ§Ã£o
case "$SELECTED" in
    "ğŸ”“ Disconnect VPN")
        if [[ -n "$ACTIVE_VPN" ]]; then
            disconnect_vpn "$ACTIVE_VPN"
        fi
        ;;
    "ğŸŸ¢ Active: $ACTIVE_VPN")
        # Clicou no status da VPN ativa - mostra informaÃ§Ãµes
        vpn_info=$(nmcli connection show "$ACTIVE_VPN" | grep -E "(vpn.data|IP4.ADDRESS|IP4.GATEWAY)" | head -3)
        notify-send "VPN Info" "VPN: $ACTIVE_VPN\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n$vpn_info" \
            --icon=network-vpn \
            --expire-time=5000
        ;;
    "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        # Separador - nÃ£o faz nada
        ;;
    "")
        # UsuÃ¡rio cancelou
        echo "SeleÃ§Ã£o cancelada"
        ;;
    ğŸ”’*)
        # Remove o emoji e conecta
        VPN_NAME=$(echo "$SELECTED" | sed 's/ğŸ”’ //')
        connect_vpn "$VPN_NAME"
        ;;
    *)
        # Fallback para nomes sem emoji
        connect_vpn "$SELECTED"
        ;;
esac
